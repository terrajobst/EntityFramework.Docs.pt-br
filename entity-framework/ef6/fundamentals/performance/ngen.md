---
title: Melhorando o desempenho de inicialização com o NGen-EF6
author: divega
ms.date: 10/23/2016
ms.assetid: dc6110a0-80a0-4370-8190-cea942841cee
ms.openlocfilehash: 841aec645abdb2a56076d0b70bfb2614b0acafb4
ms.sourcegitcommit: 37d0e0fd1703467918665a64837dc54ad2ec7484
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/16/2019
ms.locfileid: "72446000"
---
# <a name="improving-startup-performance-with-ngen"></a><span data-ttu-id="a51a7-102">Melhorando o desempenho de inicialização com o NGen</span><span class="sxs-lookup"><span data-stu-id="a51a7-102">Improving startup performance with NGen</span></span>
> [!NOTE]
> <span data-ttu-id="a51a7-103">**EF6 em diante apenas**: os recursos, as APIs etc. discutidos nessa página foram introduzidos no Entity Framework 6.</span><span class="sxs-lookup"><span data-stu-id="a51a7-103">**EF6 Onwards Only** - The features, APIs, etc. discussed in this page were introduced in Entity Framework 6.</span></span> <span data-ttu-id="a51a7-104">Se você estiver usando uma versão anterior, algumas ou todas as informações não se aplicarão.</span><span class="sxs-lookup"><span data-stu-id="a51a7-104">If you are using an earlier version, some or all of the information does not apply.</span></span>  

<span data-ttu-id="a51a7-105">O .NET Framework dá suporte à geração de imagens nativas para bibliotecas e aplicativos gerenciados como uma maneira de ajudar os aplicativos a serem iniciados mais rapidamente e também em alguns casos usam menos memória.</span><span class="sxs-lookup"><span data-stu-id="a51a7-105">The .NET Framework supports the generation of native images for managed applications and libraries as a way to help applications start faster and also in some cases use less memory.</span></span> <span data-ttu-id="a51a7-106">As imagens nativas são criadas pela tradução de assemblies de código gerenciado em arquivos que contêm instruções de máquina nativa antes de o aplicativo ser executado, aliviando o compilador JIT .NET (just-in-time) de ter que gerar as instruções nativas em tempo de execução do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a51a7-106">Native images are created by translating managed code assemblies into files containing native machine instructions before the application is executed, relieving the .NET JIT (Just-In-Time) compiler from having to generate the native instructions at application runtime.</span></span>  

<span data-ttu-id="a51a7-107">Antes da versão 6, as bibliotecas principais do tempo de execução do EF faziam parte do .NET Framework e as imagens nativas foram geradas automaticamente para eles.</span><span class="sxs-lookup"><span data-stu-id="a51a7-107">Prior to version 6, the EF runtime’s core libraries were part of the .NET Framework and native images were generated automatically for them.</span></span> <span data-ttu-id="a51a7-108">A partir da versão 6, o tempo de execução do EF inteiro foi combinado no pacote NuGet do EntityFramework.</span><span class="sxs-lookup"><span data-stu-id="a51a7-108">Starting with version 6 the whole EF runtime has been combined into the EntityFramework NuGet package.</span></span> <span data-ttu-id="a51a7-109">As imagens nativas devem agora ser geradas usando a ferramenta de linha de comando NGen. exe para obter resultados semelhantes.</span><span class="sxs-lookup"><span data-stu-id="a51a7-109">Native images have to now be generated using the NGen.exe command line tool to obtain similar results.</span></span>  

<span data-ttu-id="a51a7-110">Empírica observações mostram que as imagens nativas dos assemblies de tempo de execução do EF podem ser cortadas entre 1 e 3 segundos de tempo de inicialização do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a51a7-110">Empirical observations show that native images of the EF runtime assemblies can cut between 1 and 3 seconds of application startup time.</span></span>  

## <a name="how-to-use-ngenexe"></a><span data-ttu-id="a51a7-111">Como usar NGen. exe</span><span class="sxs-lookup"><span data-stu-id="a51a7-111">How to use NGen.exe</span></span>  

<span data-ttu-id="a51a7-112">A função mais básica da ferramenta NGen. exe é "instalar" (ou seja, criar e persistir em disco) imagens nativas para um assembly e todas as suas dependências diretas.</span><span class="sxs-lookup"><span data-stu-id="a51a7-112">The most basic function of the NGen.exe tool is to “install” (that is, to create and persist to disk) native images for an assembly and all its direct dependencies.</span></span> <span data-ttu-id="a51a7-113">Veja como você pode conseguir isso:</span><span class="sxs-lookup"><span data-stu-id="a51a7-113">Here is how you can achieve that:</span></span>  

1. <span data-ttu-id="a51a7-114">Abra uma janela de prompt de comando como administrador.</span><span class="sxs-lookup"><span data-stu-id="a51a7-114">Open a Command Prompt window as an administrator.</span></span>
2. <span data-ttu-id="a51a7-115">Altere o diretório de trabalho atual para o local dos assemblies dos quais você deseja gerar imagens nativas:</span><span class="sxs-lookup"><span data-stu-id="a51a7-115">Change the current working directory to the location of the assemblies you want to generate native images for:</span></span>

   ``` console
   cd <*Assemblies location*>  
   ```

3. <span data-ttu-id="a51a7-116">Dependendo do seu sistema operacional e da configuração do aplicativo, talvez seja necessário gerar imagens nativas para a arquitetura de 32 bits, a arquitetura de 64 bits ou para ambos.</span><span class="sxs-lookup"><span data-stu-id="a51a7-116">Depending on your operating system and the application’s configuration you might need to generate native images for 32 bit architecture, 64 bit architecture or for both.</span></span>

   <span data-ttu-id="a51a7-117">Para execução de 32 bits:</span><span class="sxs-lookup"><span data-stu-id="a51a7-117">For 32 bit run:</span></span>

   ``` console
   %WINDIR%\Microsoft.NET\Framework\v4.0.30319\ngen install <Assembly name>  
   ```

   <span data-ttu-id="a51a7-118">Para execução de 64 bits:</span><span class="sxs-lookup"><span data-stu-id="a51a7-118">For 64 bit run:</span></span>
  
   ``` console
   %WINDIR%\Microsoft.NET\Framework64\v4.0.30319\ngen install <Assembly name>  
   ```

> [!TIP]
> <span data-ttu-id="a51a7-119">A geração de imagens nativas para a arquitetura errada é um erro muito comum.</span><span class="sxs-lookup"><span data-stu-id="a51a7-119">Generating native images for the wrong architecture is a very common mistake.</span></span> <span data-ttu-id="a51a7-120">Quando em dúvida, você pode simplesmente gerar imagens nativas para todas as arquiteturas que se aplicam ao sistema operacional instalado no computador.</span><span class="sxs-lookup"><span data-stu-id="a51a7-120">When in doubt you can simply generate native images for all the architectures that apply to the operating system installed in the machine.</span></span>  

<span data-ttu-id="a51a7-121">O NGen. exe também dá suporte a outras funções, como desinstalar e exibir as imagens nativas instaladas, enfileirar a geração de várias imagens, etc. Para obter mais detalhes sobre o uso, leia a [documentação do NGen. exe](https://msdn.microsoft.com/library/6t9t5wcf.aspx).</span><span class="sxs-lookup"><span data-stu-id="a51a7-121">NGen.exe also supports other functions such as uninstalling and displaying the installed native images, queuing the generation of multiple images, etc. For more details of usage read the [NGen.exe documentation](https://msdn.microsoft.com/library/6t9t5wcf.aspx).</span></span>  

## <a name="when-to-use-ngenexe"></a><span data-ttu-id="a51a7-122">Quando usar NGen. exe</span><span class="sxs-lookup"><span data-stu-id="a51a7-122">When to use NGen.exe</span></span>  

<span data-ttu-id="a51a7-123">Quando se trata de decidir quais assemblies gerar imagens nativas para em um aplicativo baseado no EF versão 6 ou superior, você deve considerar as seguintes opções:</span><span class="sxs-lookup"><span data-stu-id="a51a7-123">When it comes to decide which assemblies to generate native images for in an application based on EF version 6 or greater, you should consider the following options:</span></span>  

- <span data-ttu-id="a51a7-124">**O assembly de tempo de execução do EF principal, EntityFramework. dll**: um aplicativo típico baseado em EF executa uma quantidade significativa de código desse assembly na inicialização ou no seu primeiro acesso ao banco de dados.</span><span class="sxs-lookup"><span data-stu-id="a51a7-124">**The main EF runtime assembly, EntityFramework.dll**: A typical EF based application executes a significant amount of code from this assembly on startup or on its first access to the database.</span></span> <span data-ttu-id="a51a7-125">Consequentemente, a criação de imagens nativas desse assembly produzirá os maiores ganhos no desempenho de inicialização.</span><span class="sxs-lookup"><span data-stu-id="a51a7-125">Consequently, creating native images of this assembly will produce the biggest gains in startup performance.</span></span>  
- <span data-ttu-id="a51a7-126">**Qualquer assembly de provedor de EF usado pelo seu aplicativo: o**tempo de inicialização também pode se beneficiar ligeiramente da geração de imagens nativas desses.</span><span class="sxs-lookup"><span data-stu-id="a51a7-126">**Any EF provider assembly used by your application**: Startup time can also benefit slightly from generating native images of these.</span></span> <span data-ttu-id="a51a7-127">Por exemplo, se o aplicativo usar o provedor do EF para SQL Server, você desejará gerar uma imagem nativa para o EntityFramework. SqlServer. dll.</span><span class="sxs-lookup"><span data-stu-id="a51a7-127">For example, if the application uses the EF provider for SQL Server you will want to generate a native image for EntityFramework.SqlServer.dll.</span></span>  
- <span data-ttu-id="a51a7-128">**Os assemblies de seu aplicativo e outras dependências**: a [documentação NGen. exe](https://msdn.microsoft.com/library/6t9t5wcf.aspx) aborda os critérios gerais para escolher quais assemblies gerar imagens nativas e o impacto de imagens nativas sobre segurança, opções avançadas como "Hard Associação ", cenários como usar imagens nativas em cenários de depuração e criação de perfil, etc.</span><span class="sxs-lookup"><span data-stu-id="a51a7-128">**Your application’s assemblies and other dependencies**: The [NGen.exe documentation](https://msdn.microsoft.com/library/6t9t5wcf.aspx) covers general criteria for choosing which assemblies to generate native images for and the impact of native images on security, advanced options such as “hard binding”, scenarios such as using native images in debugging and profiling scenarios, etc.</span></span>  

> [!TIP]
> <span data-ttu-id="a51a7-129">Certifique-se de medir cuidadosamente o impacto de usar imagens nativas no desempenho de inicialização e no desempenho geral do seu aplicativo e compará-los com os requisitos reais.</span><span class="sxs-lookup"><span data-stu-id="a51a7-129">Make sure you carefully measure the impact of using native images on both the startup performance and the overall performance of your application and compare them against actual requirements.</span></span> <span data-ttu-id="a51a7-130">Embora as imagens nativas geralmente ajudem a melhorar o desempenho de inicialização e, em alguns casos, reduzir o uso de memória, nem todos os cenários se beneficiarão igualmente.</span><span class="sxs-lookup"><span data-stu-id="a51a7-130">While native images will generally help improve startup up performance and in some cases reduce memory usage, not all scenarios will benefit equally.</span></span> <span data-ttu-id="a51a7-131">Por exemplo, na execução de estado estável (ou seja, quando todos os métodos que estão sendo usados pelo aplicativo tiverem sido invocados pelo menos uma vez), o código gerado pelo compilador JIT pode, na verdade, gerar um desempenho um pouco melhor do que as imagens nativas.</span><span class="sxs-lookup"><span data-stu-id="a51a7-131">For instance, on steady state execution (that is, once all the methods being used by the application have been invoked at least once) code generated by the JIT compiler can in fact yield slightly better performance than native images.</span></span>  

## <a name="using-ngenexe-in-a-development-machine"></a><span data-ttu-id="a51a7-132">Usando NGen. exe em um computador de desenvolvimento</span><span class="sxs-lookup"><span data-stu-id="a51a7-132">Using NGen.exe in a development machine</span></span>  

<span data-ttu-id="a51a7-133">Durante o desenvolvimento, o compilador JIT do .NET oferecerá a melhor compensação geral para o código que é alterado com frequência.</span><span class="sxs-lookup"><span data-stu-id="a51a7-133">During development the .NET JIT compiler will offer the best overall tradeoff for code that is changing frequently.</span></span> <span data-ttu-id="a51a7-134">A geração de imagens nativas para dependências compiladas, como os assemblies de tempo de execução do EF, pode ajudar a acelerar o desenvolvimento e os testes, recortando alguns segundos no início de cada execução.</span><span class="sxs-lookup"><span data-stu-id="a51a7-134">Generating native images for compiled dependencies such as the EF runtime assemblies can help accelerate development and testing by cutting a few seconds out at the beginning of each execution.</span></span>  

<span data-ttu-id="a51a7-135">Um bom local para localizar os assemblies do tempo de execução do EF é o local do pacote NuGet para a solução.</span><span class="sxs-lookup"><span data-stu-id="a51a7-135">A good place to find the EF runtime assemblies is the NuGet package location for the solution.</span></span> <span data-ttu-id="a51a7-136">Por exemplo, para um aplicativo que usa o EF 6.0.2 com SQL Server e visando o .NET 4,5 ou superior, você pode digitar o seguinte em uma janela de prompt de comando (Lembre-se de abri-lo como administrador):</span><span class="sxs-lookup"><span data-stu-id="a51a7-136">For example, for an application using EF 6.0.2 with SQL Server and targeting .NET 4.5 or greater you can type the following in a Command Prompt window (remember to open it as an administrator):</span></span>  

```console
cd <Solution directory>\packages\EntityFramework.6.0.2\lib\net45
%WINDIR%\Microsoft.NET\Framework\v4.0.30319\ngen install EntityFramework.SqlServer.dll
%WINDIR%\Microsoft.NET\Framework64\v4.0.30319\ngen install EntityFramework.SqlServer.dll
```  

> [!NOTE]
> <span data-ttu-id="a51a7-137">Isso aproveita o fato de que a instalação das imagens nativas para o provedor do EF para SQL Server também instalará por padrão as imagens nativas para o assembly de tempo de execução do EF principal.</span><span class="sxs-lookup"><span data-stu-id="a51a7-137">This takes advantage of the fact that installing the native images for EF provider for SQL Server will also by default install the native images for the main EF runtime assembly.</span></span> <span data-ttu-id="a51a7-138">Isso funciona porque o NGen. exe pode detectar que o EntityFramework. dll é uma dependência direta do assembly do EntityFramework. SqlServer. dll localizado no mesmo diretório.</span><span class="sxs-lookup"><span data-stu-id="a51a7-138">This works because NGen.exe can detect that EntityFramework.dll is a direct dependency of the EntityFramework.SqlServer.dll assembly located in the same directory.</span></span>  

## <a name="creating-native-images-during-setup"></a><span data-ttu-id="a51a7-139">Criando imagens nativas durante a instalação</span><span class="sxs-lookup"><span data-stu-id="a51a7-139">Creating native images during setup</span></span>  

<span data-ttu-id="a51a7-140">O kit de ferramentas do WiX dá suporte à colocação da geração de imagens nativas para assemblies gerenciados durante a instalação, conforme explicado neste [Guia de instruções](https://wixtoolset.org/documentation/manual/v3/howtos/files_and_registry/ngen_managed_assemblies.html).</span><span class="sxs-lookup"><span data-stu-id="a51a7-140">The WiX Toolkit supports queuing the generation of native images for managed assemblies during setup, as explained in this [how-to guide](https://wixtoolset.org/documentation/manual/v3/howtos/files_and_registry/ngen_managed_assemblies.html).</span></span> <span data-ttu-id="a51a7-141">Outra alternativa é criar uma tarefa de instalação personalizada que execute o comando NGen. exe.</span><span class="sxs-lookup"><span data-stu-id="a51a7-141">Another alternative is to create a custom setup task that execute the NGen.exe command.</span></span>  

## <a name="verifying-that-native-images-are-being-used-for-ef"></a><span data-ttu-id="a51a7-142">Verificando se as imagens nativas estão sendo usadas para o EF</span><span class="sxs-lookup"><span data-stu-id="a51a7-142">Verifying that native images are being used for EF</span></span>  

<span data-ttu-id="a51a7-143">Você pode verificar se um aplicativo específico está usando um assembly nativo procurando assemblies carregados que tenham a extensão ". ni. dll" ou ". ni. exe".</span><span class="sxs-lookup"><span data-stu-id="a51a7-143">You can verify that a specific application is using a native assembly by looking for loaded assemblies that have the extension “.ni.dll” or “.ni.exe”.</span></span> <span data-ttu-id="a51a7-144">Por exemplo, uma imagem nativa para o assembly de tempo de execução principal do EF será chamada de EntityFramework. ni. dll.</span><span class="sxs-lookup"><span data-stu-id="a51a7-144">For example, a native image for the EF’s main runtime assembly will be called EntityFramework.ni.dll.</span></span> <span data-ttu-id="a51a7-145">Uma maneira fácil de inspecionar os assemblies .NET carregados de um processo é usar o [Gerenciador de processos](https://technet.microsoft.com/sysinternals/bb896653).</span><span class="sxs-lookup"><span data-stu-id="a51a7-145">An easy way to inspect the loaded .NET assemblies of a process is to use [Process Explorer](https://technet.microsoft.com/sysinternals/bb896653).</span></span>  

## <a name="other-things-to-be-aware-of"></a><span data-ttu-id="a51a7-146">Outras coisas que você deve conhecer</span><span class="sxs-lookup"><span data-stu-id="a51a7-146">Other things to be aware of</span></span>  

<span data-ttu-id="a51a7-147">A **criação de uma imagem nativa de um assembly não deve ser confundida com o registro do assembly no [GAC (cache de assembly global)](https://msdn.microsoft.com/library/yf1d93sz.aspx)** .</span><span class="sxs-lookup"><span data-stu-id="a51a7-147">**Creating a native image of an assembly should not be confused with registering the assembly in the [GAC (Global Assembly Cache)](https://msdn.microsoft.com/library/yf1d93sz.aspx)**.</span></span> <span data-ttu-id="a51a7-148">O NGen. exe permite a criação de imagens de assemblies que não estão no GAC e, na verdade, vários aplicativos que usam uma versão específica do EF podem compartilhar a mesma imagem nativa.</span><span class="sxs-lookup"><span data-stu-id="a51a7-148">NGen.exe allows creating images of assemblies that are not in the GAC, and in fact, multiple applications that use a specific version of EF can share the same native image.</span></span> <span data-ttu-id="a51a7-149">Embora o Windows 8 possa criar automaticamente imagens nativas para assemblies colocados no GAC, o tempo de execução do EF é otimizado para ser implantado junto com seu aplicativo e não é recomendável registrá-lo no GAC, pois isso tem um impacto negativo na resolução do assembly e manutenção de seus aplicativos entre outros aspectos.</span><span class="sxs-lookup"><span data-stu-id="a51a7-149">While Windows 8 can automatically create native images for assemblies placed in the GAC, the EF runtime is optimized to be deployed alongside your application and we do not recommend registering it in the GAC as this has a negative impact on assembly resolution and servicing your applications among other aspects.</span></span>  
