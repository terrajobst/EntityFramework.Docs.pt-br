---
title: "Atualizando de versões anteriores ao EF Core 2 - Core de EF"
author: divega
ms.author: divega
ms.date: 8/13/2017
ms.assetid: 8BD43C8C-63D9-4F3A-B954-7BC518A1B7DB
ms.technology: entity-framework-core
uid: core/miscellaneous/1x-2x-upgrade
ms.openlocfilehash: 380f27c9f00943a2909ec7b876e151572a67dc37
ms.sourcegitcommit: ced2637bf8cc5964c6daa6c7fcfce501bf9ef6e8
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 12/22/2017
---
# <a name="upgrading-applications-from-previous-versions-to-ef-core-20"></a><span data-ttu-id="2a970-102">Atualizando aplicativos de versões anteriores ao EF Core 2.0</span><span class="sxs-lookup"><span data-stu-id="2a970-102">Upgrading applications from previous versions to EF Core 2.0</span></span>

## <a name="procedures-common-to-all-applications"></a><span data-ttu-id="2a970-103">Procedimentos comuns a todos os aplicativos</span><span class="sxs-lookup"><span data-stu-id="2a970-103">Procedures Common to All Applications</span></span>

<span data-ttu-id="2a970-104">Atualizando um aplicativo existente para EF Core 2.0 pode exigir:</span><span class="sxs-lookup"><span data-stu-id="2a970-104">Updating an existing application to EF Core 2.0 may require:</span></span>

1. <span data-ttu-id="2a970-105">Atualização da plataforma do .NET de destino do aplicativo para um que suporte o .NET 2.0 padrão.</span><span class="sxs-lookup"><span data-stu-id="2a970-105">Upgrading the target .NET platform of the application to one that supports .NET Standard 2.0.</span></span> <span data-ttu-id="2a970-106">Consulte [plataformas com suporte](../platforms/index.md) para obter mais detalhes.</span><span class="sxs-lookup"><span data-stu-id="2a970-106">See [Supported Platforms](../platforms/index.md) for more details.</span></span>

2. <span data-ttu-id="2a970-107">Identifica um provedor para o banco de dados de destino que é compatível com o EF Core 2.0.</span><span class="sxs-lookup"><span data-stu-id="2a970-107">Identify a provider for the target database which is compatible with EF Core 2.0.</span></span> <span data-ttu-id="2a970-108">Consulte [EF Core 2.0 requer um provedor de banco de 2.0 dados](#ef-core-20-requires-a-20-database-provider) abaixo.</span><span class="sxs-lookup"><span data-stu-id="2a970-108">See [EF Core 2.0 requires a 2.0 database provider](#ef-core-20-requires-a-20-database-provider) below.</span></span>

3. <span data-ttu-id="2a970-109">Atualizar todos os pacotes de EF Core (tempo de execução e ferramentas) 2.0.</span><span class="sxs-lookup"><span data-stu-id="2a970-109">Upgrading all the EF Core packages (runtime and tooling) to 2.0.</span></span> <span data-ttu-id="2a970-110">Consulte [instalando EF Core](../get-started/install/index.md) para obter mais detalhes.</span><span class="sxs-lookup"><span data-stu-id="2a970-110">Refer to [Installing EF Core](../get-started/install/index.md) for more details.</span></span>

4. <span data-ttu-id="2a970-111">Faça as alterações necessárias de código para compensar alterações significativas.</span><span class="sxs-lookup"><span data-stu-id="2a970-111">Make any necessary code changes to compensate for breaking changes.</span></span> <span data-ttu-id="2a970-112">Consulte o [alterações significativas](#breaking-changes) seção abaixo para obter mais detalhes.</span><span class="sxs-lookup"><span data-stu-id="2a970-112">See the [Breaking Changes](#breaking-changes) section below for more details.</span></span>

## <a name="aspnet-core-applications"></a><span data-ttu-id="2a970-113">Aplicativos do ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="2a970-113">ASP.NET Core applications</span></span>

1. <span data-ttu-id="2a970-114">Consulte em particular a [novo padrão para inicializar o provedor de serviços do aplicativo](#new-way-of-getting-application-services) descrito abaixo.</span><span class="sxs-lookup"><span data-stu-id="2a970-114">See in particular the [new pattern for initializing the application's service provider](#new-way-of-getting-application-services) described below.</span></span>

> [!TIP]  
> <span data-ttu-id="2a970-115">A adoção desse novo padrão quando atualizar aplicativos 2.0 é altamente recomendado e é necessário para recursos de produto como Entity Framework Core migrações para trabalhar.</span><span class="sxs-lookup"><span data-stu-id="2a970-115">The adoption of this new pattern when updating applications to 2.0 is highly recommended and is required in order for product features like Entity Framework Core Migrations to work.</span></span> <span data-ttu-id="2a970-116">A outra alternativa comum é [implementar *IDesignTimeDbContextFactory\<TContext >*](xref:core/miscellaneous/cli/dbcontext-creation#from-a-design-time-factory).</span><span class="sxs-lookup"><span data-stu-id="2a970-116">The other common alternative is to [implement *IDesignTimeDbContextFactory\<TContext>*](xref:core/miscellaneous/cli/dbcontext-creation#from-a-design-time-factory).</span></span>

2. <span data-ttu-id="2a970-117">Aplicativos que têm como destino o ASP.NET Core 2.0 podem usar o EF Core 2.0 sem dependências adicionais além de provedores de banco de dados de terceiros.</span><span class="sxs-lookup"><span data-stu-id="2a970-117">Applications targeting ASP.NET Core 2.0 can use EF Core 2.0 without additional dependencies besides third party database providers.</span></span> <span data-ttu-id="2a970-118">No entanto, aplicativos destinados a versões anteriores do ASP.NET Core precisam atualizar para o ASP.NET 2.0 de núcleo para usar o EF Core 2.0.</span><span class="sxs-lookup"><span data-stu-id="2a970-118">However, applications targeting previous versions of ASP.NET Core need to upgrade to ASP.NET Core 2.0 in order to use EF Core 2.0.</span></span> <span data-ttu-id="2a970-119">Para obter mais detalhes sobre como atualizar aplicativos ASP.NET Core 2.0, consulte [a documentação do ASP.NET Core no assunto](https://docs.microsoft.com/aspnet/core/migration/1x-to-2x/).</span><span class="sxs-lookup"><span data-stu-id="2a970-119">For more details on upgrading ASP.NET Core applications to 2.0 see [the ASP.NET Core documentation on the subject](https://docs.microsoft.com/aspnet/core/migration/1x-to-2x/).</span></span>

## <a name="breaking-changes"></a><span data-ttu-id="2a970-120">Alterações significativas</span><span class="sxs-lookup"><span data-stu-id="2a970-120">Breaking Changes</span></span>

<span data-ttu-id="2a970-121">Levamos a oportunidade de refinar significativamente os comportamentos no 2.0 e APIs existentes.</span><span class="sxs-lookup"><span data-stu-id="2a970-121">We have taken the opportunity to significantly refine our existing APIs and behaviors in 2.0.</span></span> <span data-ttu-id="2a970-122">Existem alguns aprimoramentos que podem exigir a modificação do código de aplicativo existente, embora acreditamos que para a maioria dos aplicativos o impacto será baixo, na maioria dos casos que exigem apenas recompilação e alterações mínimas de interativa para substituir as APIs obsoletas.</span><span class="sxs-lookup"><span data-stu-id="2a970-122">There are a few improvements that can require modifying existing application code, although we believe that for the majority of applications the impact will be low, in most cases requiring just recompilation and minimal guided changes to replace obsolete APIs.</span></span>

### <a name="new-way-of-getting-application-services"></a><span data-ttu-id="2a970-123">Nova maneira de obter serviços de aplicativo</span><span class="sxs-lookup"><span data-stu-id="2a970-123">New way of getting application services</span></span>

<span data-ttu-id="2a970-124">O padrão recomendado para aplicativos da web de ASP.NET Core foi atualizado para 2.0 de forma que interrompeu a lógica de tempo de design que EF principal usada em 1. x.</span><span class="sxs-lookup"><span data-stu-id="2a970-124">The recommended pattern for ASP.NET Core web applications has been updated for 2.0 in a way that broke the design-time logic EF Core used in 1.x.</span></span> <span data-ttu-id="2a970-125">Anteriormente em tempo de design, Core EF tentar invocar `Startup.ConfigureServices` diretamente para acessar o provedor de serviços do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="2a970-125">Previously at design-time, EF Core would try to invoke `Startup.ConfigureServices` directly in order to access the application's service provider.</span></span> <span data-ttu-id="2a970-126">No ASP.NET 2.0 de núcleo, a configuração é inicializada fora do `Startup` classe.</span><span class="sxs-lookup"><span data-stu-id="2a970-126">In ASP.NET Core 2.0, Configuration is initialized outside of the `Startup` class.</span></span> <span data-ttu-id="2a970-127">Aplicativos que utilizam o EF Core geralmente acessam sua cadeia de caracteres de conexão de configuração, portanto `Startup` por si só não é suficiente.</span><span class="sxs-lookup"><span data-stu-id="2a970-127">Applications using EF Core typically access their connection string from Configuration, so `Startup` by itself is no longer sufficient.</span></span> <span data-ttu-id="2a970-128">Se você atualizar um aplicativo do ASP.NET Core 1. x, você receberá o seguinte erro ao usar as ferramentas de EF Core.</span><span class="sxs-lookup"><span data-stu-id="2a970-128">If you upgrade an ASP.NET Core 1.x application, you may receive the following error when using the EF Core tools.</span></span>

> <span data-ttu-id="2a970-129">Nenhum construtor sem parâmetros foi encontrado em 'ApplicationContext'.</span><span class="sxs-lookup"><span data-stu-id="2a970-129">No parameterless constructor was found on 'ApplicationContext'.</span></span> <span data-ttu-id="2a970-130">Adicione um construtor sem parâmetros para 'ApplicationContext' ou adicione uma implementação de ' IDesignTimeDbContextFactory&lt;ApplicationContext&gt;' no mesmo assembly como 'ApplicationContext'</span><span class="sxs-lookup"><span data-stu-id="2a970-130">Either add a parameterless constructor to 'ApplicationContext' or add an implementation of 'IDesignTimeDbContextFactory&lt;ApplicationContext&gt;' in the same assembly as 'ApplicationContext'</span></span>

<span data-ttu-id="2a970-131">Foi adicionado um novo gancho de tempo de design no modelo de padrão do ASP.NET Core 2.0.</span><span class="sxs-lookup"><span data-stu-id="2a970-131">A new design-time hook has been added in ASP.NET Core 2.0's default template.</span></span> <span data-ttu-id="2a970-132">Estático `Program.BuildWebHost` método permite que o EF principal acessar o provedor de serviços do aplicativo em tempo de design.</span><span class="sxs-lookup"><span data-stu-id="2a970-132">The static `Program.BuildWebHost` method enables EF Core to access the application's service provider at design time.</span></span> <span data-ttu-id="2a970-133">Se você estiver atualizando um aplicativo do ASP.NET Core 1. x, você precisará atualizar `Program` classe para ser semelhante à seguinte.</span><span class="sxs-lookup"><span data-stu-id="2a970-133">If you are upgrading an ASP.NET Core 1.x application, you will need to update you `Program` class to resemble the following.</span></span>

``` csharp
using Microsoft.AspNetCore;
using Microsoft.AspNetCore.Hosting;

namespace AspNetCoreDotNetCore2._0App
{
    public class Program
    {
        public static void Main(string[] args)
        {
            BuildWebHost(args).Run();
        }

        public static IWebHost BuildWebHost(string[] args) =>
            WebHost.CreateDefaultBuilder(args)
                .UseStartup<Startup>()
                .Build();
    }
}
```

### <a name="idbcontextfactory-renamed"></a><span data-ttu-id="2a970-134">IDbContextFactory renomeado</span><span class="sxs-lookup"><span data-stu-id="2a970-134">IDbContextFactory renamed</span></span>

<span data-ttu-id="2a970-135">Para dar suporte a padrões de diversos aplicativos e fornecer aos usuários mais controle sobre como suas `DbContext` é usada em tempo de design, nós fornecemos, no passado, o `IDbContextFactory<TContext>` interface.</span><span class="sxs-lookup"><span data-stu-id="2a970-135">In order to support diverse application patterns and give users more control over how their `DbContext` is used at design time, we have, in the past, provided the `IDbContextFactory<TContext>` interface.</span></span> <span data-ttu-id="2a970-136">Em tempo de design, as ferramentas principais EF descobrirá implementações dessa interface em seu projeto e usá-lo para criar `DbContext` objetos.</span><span class="sxs-lookup"><span data-stu-id="2a970-136">At design-time, the EF Core tools will discover implementations of this interface in your project and use it to create `DbContext` objects.</span></span>

<span data-ttu-id="2a970-137">Essa interface tiver um nome muito geral que alguns usuários para tentar novamente usando-o para outro de enganar `DbContext`-criação de cenários.</span><span class="sxs-lookup"><span data-stu-id="2a970-137">This interface had a very general name which mislead some users to try re-using it for other `DbContext`-creating scenarios.</span></span> <span data-ttu-id="2a970-138">Foram pega de surpresa quando as ferramentas de EF, em seguida, tentou usar sua implementação em tempo de design e causados comandos como `Update-Database` ou `dotnet ef database update` falha.</span><span class="sxs-lookup"><span data-stu-id="2a970-138">They were caught off guard when the EF Tools then tried to use their implementation at design-time and caused commands like `Update-Database` or `dotnet ef database update` to fail.</span></span>

<span data-ttu-id="2a970-139">Para comunicar-se a semântica de tempo de design forte desta interface, podemos ter renomeado para `IDesignTimeDbContextFactory<TContext>`.</span><span class="sxs-lookup"><span data-stu-id="2a970-139">In order to communicate the strong design-time semantics of this interface, we have renamed it to `IDesignTimeDbContextFactory<TContext>`.</span></span>

<span data-ttu-id="2a970-140">Para obter o 2.0 versão o `IDbContextFactory<TContext>` ainda existe, mas está marcado como obsoleto.</span><span class="sxs-lookup"><span data-stu-id="2a970-140">For the 2.0 release the `IDbContextFactory<TContext>` still exists but is marked as obsolete.</span></span>

### <a name="dbcontextfactoryoptions-removed"></a><span data-ttu-id="2a970-141">DbContextFactoryOptions removido</span><span class="sxs-lookup"><span data-stu-id="2a970-141">DbContextFactoryOptions removed</span></span>

<span data-ttu-id="2a970-142">Devido às alterações de ASP.NET Core 2.0 descritas acima, descobrimos que `DbContextFactoryOptions` não era mais necessário no novo `IDesignTimeDbContextFactory<TContext>` interface.</span><span class="sxs-lookup"><span data-stu-id="2a970-142">Because of the ASP.NET Core 2.0 changes described above, we found that `DbContextFactoryOptions` was no longer needed on the new `IDesignTimeDbContextFactory<TContext>` interface.</span></span> <span data-ttu-id="2a970-143">Aqui estão as alternativas, que você deve usar em vez disso.</span><span class="sxs-lookup"><span data-stu-id="2a970-143">Here are the alternatives you should be using instead.</span></span>

<span data-ttu-id="2a970-144">DbContextFactoryOptions</span><span class="sxs-lookup"><span data-stu-id="2a970-144">DbContextFactoryOptions</span></span> | <span data-ttu-id="2a970-145">Alternativa</span><span class="sxs-lookup"><span data-stu-id="2a970-145">Alternative</span></span>
--- | ---
<span data-ttu-id="2a970-146">ApplicationBasePath</span><span class="sxs-lookup"><span data-stu-id="2a970-146">ApplicationBasePath</span></span> | <span data-ttu-id="2a970-147">AppContext.BaseDirectory</span><span class="sxs-lookup"><span data-stu-id="2a970-147">AppContext.BaseDirectory</span></span>
<span data-ttu-id="2a970-148">ContentRootPath</span><span class="sxs-lookup"><span data-stu-id="2a970-148">ContentRootPath</span></span> | <span data-ttu-id="2a970-149">Directory.GetCurrentDirectory()</span><span class="sxs-lookup"><span data-stu-id="2a970-149">Directory.GetCurrentDirectory()</span></span>
<span data-ttu-id="2a970-150">EnvironmentName</span><span class="sxs-lookup"><span data-stu-id="2a970-150">EnvironmentName</span></span> | <span data-ttu-id="2a970-151">Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT")</span><span class="sxs-lookup"><span data-stu-id="2a970-151">Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT")</span></span>

### <a name="design-time-working-directory-changed"></a><span data-ttu-id="2a970-152">Diretório de trabalho de tempo de design alterado</span><span class="sxs-lookup"><span data-stu-id="2a970-152">Design-time working directory changed</span></span>

<span data-ttu-id="2a970-153">As alterações do ASP.NET Core 2.0 também necessário o diretório de trabalho usado por `dotnet ef` para se alinhar com o diretório de trabalho usado pelo Visual Studio ao executar seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="2a970-153">The ASP.NET Core 2.0 changes also required the working directory used by `dotnet ef` to align with the working directory used by Visual Studio when running your application.</span></span> <span data-ttu-id="2a970-154">Um efeito colateral observável disso é que SQLite nomes de arquivos agora estão em relação ao diretório do projeto e não no diretório de saída que costumavam ser.</span><span class="sxs-lookup"><span data-stu-id="2a970-154">One observable side effect of this is that SQLite filenames are now relative to the project directory and not the output directory like they used to be.</span></span>

### <a name="ef-core-20-requires-a-20-database-provider"></a><span data-ttu-id="2a970-155">EF Core 2.0 requer um provedor de banco de 2.0 dados</span><span class="sxs-lookup"><span data-stu-id="2a970-155">EF Core 2.0 requires a 2.0 database provider</span></span>

<span data-ttu-id="2a970-156">Para o EF Core 2.0 fizemos muitas simplificações e aprimoramentos nos provedores de banco de dados de maneira de trabalho.</span><span class="sxs-lookup"><span data-stu-id="2a970-156">For EF Core 2.0 we have made many simplifications and improvements in the way database providers work.</span></span> <span data-ttu-id="2a970-157">Isso significa que provedores 1.0. x e 1.1 não funcionarão com o EF Core 2.0.</span><span class="sxs-lookup"><span data-stu-id="2a970-157">This means that 1.0.x and 1.1.x providers will not work with EF Core 2.0.</span></span>

<span data-ttu-id="2a970-158">Os provedores SQL Server e SQLite são fornecidos pela equipe do EF e 2.0 versões estarão disponíveis como parte do 2.0 de versão.</span><span class="sxs-lookup"><span data-stu-id="2a970-158">The SQL Server and SQLite providers are shipped by the EF team and 2.0 versions will be available as part of the 2.0 release.</span></span> <span data-ttu-id="2a970-159">Os provedores de terceiros do código-fonte aberto para [SQL Compact](https://github.com/ErikEJ/EntityFramework.SqlServerCompact), [PostgreSQL](https://github.com/npgsql/Npgsql.EntityFrameworkCore.PostgreSQL), e [MySQL](https://github.com/PomeloFoundation/Pomelo.EntityFrameworkCore.MySql) estão sendo atualizadas para 2.0.</span><span class="sxs-lookup"><span data-stu-id="2a970-159">The open-source third party providers for [SQL Compact](https://github.com/ErikEJ/EntityFramework.SqlServerCompact), [PostgreSQL](https://github.com/npgsql/Npgsql.EntityFrameworkCore.PostgreSQL), and [MySQL](https://github.com/PomeloFoundation/Pomelo.EntityFrameworkCore.MySql) are being updated for 2.0.</span></span> <span data-ttu-id="2a970-160">Para todos os outros provedores, entre em contato com o gravador de provedor.</span><span class="sxs-lookup"><span data-stu-id="2a970-160">For all other providers, please contact the provider writer.</span></span>

### <a name="logging-and-diagnostics-events-have-changed"></a><span data-ttu-id="2a970-161">Eventos de log e diagnóstico foram alterados</span><span class="sxs-lookup"><span data-stu-id="2a970-161">Logging and Diagnostics events have changed</span></span>

<span data-ttu-id="2a970-162">Observação: essas alterações não devem afetar a maioria dos códigos de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="2a970-162">Note: these changes should not impact most application code.</span></span>

<span data-ttu-id="2a970-163">As identificações de evento das mensagens enviadas para um [ILogger](https://github.com/aspnet/Logging/blob/dev/src/Microsoft.Extensions.Logging.Abstractions/ILogger.cs) foram alterados no 2.0.</span><span class="sxs-lookup"><span data-stu-id="2a970-163">The event IDs for messages sent to an [ILogger](https://github.com/aspnet/Logging/blob/dev/src/Microsoft.Extensions.Logging.Abstractions/ILogger.cs) have changed in 2.0.</span></span> <span data-ttu-id="2a970-164">As IDs de evento são exclusivas em todo o código do EF Core.</span><span class="sxs-lookup"><span data-stu-id="2a970-164">The event IDs are now unique across EF Core code.</span></span> <span data-ttu-id="2a970-165">Essas mensagens agora também seguem o padrão para o registro em log estruturado usado pelo MVC, por exemplo.</span><span class="sxs-lookup"><span data-stu-id="2a970-165">These messages now also follow the standard pattern for structured logging used by, for example, MVC.</span></span>

<span data-ttu-id="2a970-166">As categorias de agente também foram alteradas.</span><span class="sxs-lookup"><span data-stu-id="2a970-166">Logger categories have also changed.</span></span> <span data-ttu-id="2a970-167">Há agora um conjunto bem conhecido de categorias acessadas por meio de [DbLoggerCategory](https://github.com/aspnet/EntityFramework/blob/dev/src/EFCore/DbLoggerCategory.cs).</span><span class="sxs-lookup"><span data-stu-id="2a970-167">There is now a well-known set of categories accessed through [DbLoggerCategory](https://github.com/aspnet/EntityFramework/blob/dev/src/EFCore/DbLoggerCategory.cs).</span></span>

<span data-ttu-id="2a970-168">[DiagnosticSource](https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md) eventos agora usam os mesmos nomes de ID de evento como correspondente `ILogger` mensagens.</span><span class="sxs-lookup"><span data-stu-id="2a970-168">[DiagnosticSource](https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md) events now use the same event ID names as the corresponding `ILogger` messages.</span></span> <span data-ttu-id="2a970-169">As cargas do evento são todos os tipos nominais derivados de [EventData](https://github.com/aspnet/EntityFramework/blob/dev/src/EFCore/Diagnostics/EventData.cs).</span><span class="sxs-lookup"><span data-stu-id="2a970-169">The event payloads are all nominal types derived from [EventData](https://github.com/aspnet/EntityFramework/blob/dev/src/EFCore/Diagnostics/EventData.cs).</span></span>

<span data-ttu-id="2a970-170">Categorias, tipos de carga e IDs de eventos estão documentadas no [CoreEventId](https://github.com/aspnet/EntityFramework/blob/dev/src/EFCore/Diagnostics/CoreEventId.cs) e [RelationalEventId](https://github.com/aspnet/EntityFramework/blob/dev/src/EFCore.Relational/Diagnostics/RelationalEventId.cs) classes.</span><span class="sxs-lookup"><span data-stu-id="2a970-170">Event IDs, payload types, and categories are documented in the [CoreEventId](https://github.com/aspnet/EntityFramework/blob/dev/src/EFCore/Diagnostics/CoreEventId.cs) and the [RelationalEventId](https://github.com/aspnet/EntityFramework/blob/dev/src/EFCore.Relational/Diagnostics/RelationalEventId.cs) classes.</span></span>

<span data-ttu-id="2a970-171">IDs também foram movidos de Microsoft.EntityFrameworkCore.Infraestructure para o novo namespace Microsoft.EntityFrameworkCore.Diagnostics.</span><span class="sxs-lookup"><span data-stu-id="2a970-171">IDs have also moved from Microsoft.EntityFrameworkCore.Infraestructure to the new Microsoft.EntityFrameworkCore.Diagnostics namespace.</span></span>

### <a name="ef-core-relational-metadata-api-changes"></a><span data-ttu-id="2a970-172">Alterações de metadados relacionais API Core EF</span><span class="sxs-lookup"><span data-stu-id="2a970-172">EF Core relational metadata API changes</span></span>

<span data-ttu-id="2a970-173">O EF Core 2.0 agora criará um [IModel](https://github.com/aspnet/EntityFramework/blob/dev/src/EFCore/Metadata/IModel.cs) diferente para cada provedor diferente que está sendo usado.</span><span class="sxs-lookup"><span data-stu-id="2a970-173">EF Core 2.0 will now build a different [IModel](https://github.com/aspnet/EntityFramework/blob/dev/src/EFCore/Metadata/IModel.cs) for each different provider being used.</span></span> <span data-ttu-id="2a970-174">Isso normalmente é transparente para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="2a970-174">This is usually transparent to the application.</span></span> <span data-ttu-id="2a970-175">Isso facilitou uma simplificação de APIs de metadados de nível inferior de modo que qualquer acesso a _conceitos de metadados relacionados comuns_ pé feito sempre por meio de uma chamada para `.Relational`, em vez de `.SqlServer`, `.Sqlite` etc. Por exemplo, 1.1 código como este:</span><span class="sxs-lookup"><span data-stu-id="2a970-175">This has facilitated a simplification of lower-level metadata APIs such that any access to _common relational metadata concepts_ is always made through a call to `.Relational` instead of `.SqlServer`, `.Sqlite`, etc. For example, 1.1.x code like this:</span></span>

``` csharp
var tableName = context.Model.FindEntityType(typeof(User)).SqlServer().TableName;
```

<span data-ttu-id="2a970-176">Agora deve ser escrito como este:</span><span class="sxs-lookup"><span data-stu-id="2a970-176">Should now be written like this:</span></span>

``` csharp
var tableName = context.Model.FindEntityType(typeof(User)).Relational().TableName;
```

<span data-ttu-id="2a970-177">Em vez de usar os métodos, como `ForSqlServerToTable`, métodos de extensão estão agora disponíveis para escrever código condicional com base no provedor atual em uso.</span><span class="sxs-lookup"><span data-stu-id="2a970-177">Instead of using methods like `ForSqlServerToTable`, extension methods are now available to write conditional code based on the current provider in use.</span></span> <span data-ttu-id="2a970-178">Por exemplo:</span><span class="sxs-lookup"><span data-stu-id="2a970-178">For example:</span></span>

```C#
modelBuilder.Entity<User>().ToTable(
    Database.IsSqlServer() ? "SqlServerName" : "OtherName");
```

<span data-ttu-id="2a970-179">Observe que essa alteração se aplica apenas a APIs/metadados que está definido para _todos os_ provedores relacionais.</span><span class="sxs-lookup"><span data-stu-id="2a970-179">Note that this change only applies to APIs/metadata that is defined for _all_ relational providers.</span></span> <span data-ttu-id="2a970-180">A API e metadados permanece o mesmo quando ele é específico para apenas um único provedor.</span><span class="sxs-lookup"><span data-stu-id="2a970-180">The API and metadata remains the same when it is specific to only a single provider.</span></span> <span data-ttu-id="2a970-181">Por exemplo, os índices clusterizados são específicos para SQL Server, portanto `ForSqlServerIsClustered` e `.SqlServer().IsClustered()` deve ser usado.</span><span class="sxs-lookup"><span data-stu-id="2a970-181">For example, clustered indexes are specific to SQL Sever, so `ForSqlServerIsClustered` and  `.SqlServer().IsClustered()` must still be used.</span></span>

### <a name="dont-take-control-of-the-ef-service-provider"></a><span data-ttu-id="2a970-182">Não assumir o controle do provedor de serviços EF</span><span class="sxs-lookup"><span data-stu-id="2a970-182">Don’t take control of the EF service provider</span></span>

<span data-ttu-id="2a970-183">Núcleo EF usa interno `IServiceProvider` (ou seja, um contêiner de injeção de dependência) para sua implementação interna.</span><span class="sxs-lookup"><span data-stu-id="2a970-183">EF Core uses an internal `IServiceProvider` (i.e. a dependency injection container) for its internal implementation.</span></span> <span data-ttu-id="2a970-184">Aplicativos devem permitir que o EF principal criar e gerenciar esse provedor, exceto em casos especiais.</span><span class="sxs-lookup"><span data-stu-id="2a970-184">Applications should allow EF Core to create and manage this provider except in special cases.</span></span> <span data-ttu-id="2a970-185">Altamente Considere remover todas as chamadas para `UseInternalServiceProvider`.</span><span class="sxs-lookup"><span data-stu-id="2a970-185">Strongly consider removing any calls to `UseInternalServiceProvider`.</span></span> <span data-ttu-id="2a970-186">Se um aplicativo precisa chamar `UseInternalServiceProvider`, em seguida, considere [um problema de arquivamento](https://github.com/aspnet/EntityFramework/Issues) para investigamos outras maneiras de tratar o cenário.</span><span class="sxs-lookup"><span data-stu-id="2a970-186">If an application does need to call `UseInternalServiceProvider`, then please consider [filing an issue](https://github.com/aspnet/EntityFramework/Issues) so we can investigate other ways to handle your scenario.</span></span>

<span data-ttu-id="2a970-187">Chamando `AddEntityFramework`, `AddEntityFrameworkSqlServer`, etc. não é necessário pelo código do aplicativo, a menos que `UseInternalServiceProvider` também é chamado.</span><span class="sxs-lookup"><span data-stu-id="2a970-187">Calling `AddEntityFramework`, `AddEntityFrameworkSqlServer`, etc. is not required by application code unless `UseInternalServiceProvider` is also called.</span></span> <span data-ttu-id="2a970-188">Remova as chamadas existentes para `AddEntityFramework` ou `AddEntityFrameworkSqlServer`, etc. `AddDbContext` ainda deve ser usada da mesma forma como antes.</span><span class="sxs-lookup"><span data-stu-id="2a970-188">Remove any existing calls to `AddEntityFramework` or `AddEntityFrameworkSqlServer`, etc. `AddDbContext` should still be used in the same way as before.</span></span>

### <a name="in-memory-databases-must-be-named"></a><span data-ttu-id="2a970-189">Bancos de dados na memória devem ser nomeados.</span><span class="sxs-lookup"><span data-stu-id="2a970-189">In-memory databases must be named</span></span>

<span data-ttu-id="2a970-190">O banco de dados sem nome por na memória global foi removido e, em vez disso, todos os bancos de dados na memória devem ser nomeados.</span><span class="sxs-lookup"><span data-stu-id="2a970-190">The global unnamed in-memory database has been removed and instead all in-memory databases must be named.</span></span> <span data-ttu-id="2a970-191">Por exemplo:</span><span class="sxs-lookup"><span data-stu-id="2a970-191">For example:</span></span>

``` csharp
optionsBuilder.UseInMemoryDatabase("MyDatabase");
```

<span data-ttu-id="2a970-192">Isso cria/usa um banco de dados com o nome "MyDatabase".</span><span class="sxs-lookup"><span data-stu-id="2a970-192">This creates/uses a database with the name “MyDatabase”.</span></span> <span data-ttu-id="2a970-193">Se `UseInMemoryDatabase` é chamado novamente com o mesmo nome, o mesmo banco de dados na memória será usado, permitindo que ele seja compartilhado por várias instâncias de contexto.</span><span class="sxs-lookup"><span data-stu-id="2a970-193">If `UseInMemoryDatabase` is called again with the same name, then the same in-memory database will be used, allowing it to be shared by multiple context instances.</span></span>

### <a name="read-only-api-changes"></a><span data-ttu-id="2a970-194">Alterações de API de somente leitura</span><span class="sxs-lookup"><span data-stu-id="2a970-194">Read-only API changes</span></span>

<span data-ttu-id="2a970-195">`IsReadOnlyBeforeSave`, `IsReadOnlyAferSave`, e `IsStoreGeneratedAlways` obsoletos e substituídos por [BeforeSaveBehavior](https://github.com/aspnet/EntityFramework/blob/dev/src/EFCore/Metadata/IProperty.cs#L39) e [AfterSaveBehavior](https://github.com/aspnet/EntityFramework/blob/dev/src/EFCore/Metadata/IProperty.cs#L55).</span><span class="sxs-lookup"><span data-stu-id="2a970-195">`IsReadOnlyBeforeSave`, `IsReadOnlyAferSave`, and `IsStoreGeneratedAlways` have been obsoleted and replaced with [BeforeSaveBehavior](https://github.com/aspnet/EntityFramework/blob/dev/src/EFCore/Metadata/IProperty.cs#L39) and [AfterSaveBehavior](https://github.com/aspnet/EntityFramework/blob/dev/src/EFCore/Metadata/IProperty.cs#L55).</span></span> <span data-ttu-id="2a970-196">Esses comportamentos se aplicam a qualquer propriedade (não apenas propriedades geradas pelo repositório) e determinar como o valor da propriedade deve ser usado ao inserir em uma linha de banco de dados (`BeforeSaveBehavior`) ou quando uma existente de atualização de banco de dados linha (`AfterSaveBehavior`).</span><span class="sxs-lookup"><span data-stu-id="2a970-196">These behaviors apply to any property (not only store-generated properties) and determine how the value of the property should be used when inserting into a database row (`BeforeSaveBehavior`) or when updating an existing database row (`AfterSaveBehavior`).</span></span>

<span data-ttu-id="2a970-197">Propriedades marcadas como [ValueGenerated.OnAddOrUpdate](https://github.com/aspnet/EntityFramework/blob/dev/src/EFCore/Metadata/ValueGenerated.cs) (por exemplo, para colunas computadas) por padrão ignorará qualquer valor atualmente definido na propriedade.</span><span class="sxs-lookup"><span data-stu-id="2a970-197">Properties marked as [ValueGenerated.OnAddOrUpdate](https://github.com/aspnet/EntityFramework/blob/dev/src/EFCore/Metadata/ValueGenerated.cs) (e.g. for computed columns) will by default ignore any value currently set on the property.</span></span> <span data-ttu-id="2a970-198">Isso significa que um valor gerado pelo repositório sempre será obtido independentemente se nenhum valor foi definido ou modificado na entidade controlada.</span><span class="sxs-lookup"><span data-stu-id="2a970-198">This means that a store-generated value will always be obtained regardless of whether any value has been set or modified on the tracked entity.</span></span> <span data-ttu-id="2a970-199">Isso pode ser alterado definindo outro `Before\AfterSaveBehavior`.</span><span class="sxs-lookup"><span data-stu-id="2a970-199">This can be changed by setting a different `Before\AfterSaveBehavior`.</span></span>

### <a name="new-clientsetnull-delete-behavior"></a><span data-ttu-id="2a970-200">Novo comportamento de exclusão ClientSetNull</span><span class="sxs-lookup"><span data-stu-id="2a970-200">New ClientSetNull delete behavior</span></span>

<span data-ttu-id="2a970-201">Em versões anteriores, [DeleteBehavior.Restrict](https://github.com/aspnet/EntityFramework/blob/dev/src/EFCore/Metadata/DeleteBehavior.cs) teve um comportamento para entidades controladas pelo contexto que mais fechado correspondentes `SetNull` semântica.</span><span class="sxs-lookup"><span data-stu-id="2a970-201">In previous releases, [DeleteBehavior.Restrict](https://github.com/aspnet/EntityFramework/blob/dev/src/EFCore/Metadata/DeleteBehavior.cs) had a behavior for entities tracked by the context that more closed matched `SetNull` semantics.</span></span> <span data-ttu-id="2a970-202">No EF Core 2.0, um novo `ClientSetNull` comportamento foi introduzido como padrão para relações opcionais.</span><span class="sxs-lookup"><span data-stu-id="2a970-202">In EF Core 2.0, a new `ClientSetNull` behavior has been introduced as the default for optional relationships.</span></span> <span data-ttu-id="2a970-203">Esse comportamento tem `SetNull` semântica para entidades controladas e `Restrict` comportamento para bancos de dados criados usando EF Core.</span><span class="sxs-lookup"><span data-stu-id="2a970-203">This behavior has `SetNull` semantics for tracked entities and `Restrict` behavior for databases created using EF Core.</span></span> <span data-ttu-id="2a970-204">Em nossa experiência, esses são os comportamentos mais esperado/úteis para entidades controladas e o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="2a970-204">In our experience, these are the most expected/useful behaviors for tracked entities and the database.</span></span> <span data-ttu-id="2a970-205">`DeleteBehavior.Restrict`Agora é cumprido para entidades controladas quando definidas para relações opcionais.</span><span class="sxs-lookup"><span data-stu-id="2a970-205">`DeleteBehavior.Restrict` is now honored for tracked entities when set for optional relationships.</span></span>

### <a name="provider-design-time-packages-removed"></a><span data-ttu-id="2a970-206">Pacotes de tempo de design de provedor removidos</span><span class="sxs-lookup"><span data-stu-id="2a970-206">Provider design-time packages removed</span></span>

<span data-ttu-id="2a970-207">O `Microsoft.EntityFrameworkCore.Relational.Design` pacote tiver sido removido.</span><span class="sxs-lookup"><span data-stu-id="2a970-207">The `Microsoft.EntityFrameworkCore.Relational.Design` package has been removed.</span></span> <span data-ttu-id="2a970-208">Conteúdo do arquivo foram consolidado em `Microsoft.EntityFrameworkCore.Relational` e `Microsoft.EntityFrameworkCore.Design`.</span><span class="sxs-lookup"><span data-stu-id="2a970-208">It's contents were consolidated into `Microsoft.EntityFrameworkCore.Relational` and `Microsoft.EntityFrameworkCore.Design`.</span></span>

<span data-ttu-id="2a970-209">Isso é propagada para os pacotes de tempo de design do provedor.</span><span class="sxs-lookup"><span data-stu-id="2a970-209">This propagates into the provider design-time packages.</span></span> <span data-ttu-id="2a970-210">Esses pacotes (`Microsoft.EntityFrameworkCore.Sqlite.Design`, `Microsoft.EntityFrameworkCore.SqlServer.Design`, etc.) foram removidas e seus conteúdos são consolidados em pacotes do provedor principal.</span><span class="sxs-lookup"><span data-stu-id="2a970-210">Those packages (`Microsoft.EntityFrameworkCore.Sqlite.Design`, `Microsoft.EntityFrameworkCore.SqlServer.Design`, etc.) were removed and their contents consolidated into the main provider packages.</span></span>

<span data-ttu-id="2a970-211">Para habilitar `Scaffold-DbContext` ou `dotnet ef dbcontext scaffold` no EF Core 2.0, você só precisa referenciar o pacote único provedor:</span><span class="sxs-lookup"><span data-stu-id="2a970-211">To enable `Scaffold-DbContext` or `dotnet ef dbcontext scaffold` in EF Core 2.0, you only need to reference the single provider package:</span></span>

``` xml
<PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer"
    Version="2.0.0" />
<PackageReference Include="Microsoft.EntityFrameworkCore.Tools"
    Version="2.0.0"
    PrivateAssets="All" />
<DotNetCliToolReference Include="Microsoft.EntityFrameworkCore.Tools.DotNet"
    Version="2.0.0" />
```
