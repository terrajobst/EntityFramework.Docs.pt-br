---
title: Acompanhamento versus consultas sem controle-EF Core
author: smitpatel
ms.date: 10/10/2019
ms.assetid: e17e060c-929f-4180-8883-40c438fbcc01
uid: core/querying/tracking
ms.openlocfilehash: a6c71c12f429f1324abe91d1b2cef96312bec051
ms.sourcegitcommit: cc0ff36e46e9ed3527638f7208000e8521faef2e
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 03/06/2020
ms.locfileid: "78417645"
---
# <a name="tracking-vs-no-tracking-queries"></a><span data-ttu-id="8cde9-102">Acompanhamento versus consultas sem controle</span><span class="sxs-lookup"><span data-stu-id="8cde9-102">Tracking vs. No-Tracking Queries</span></span>

<span data-ttu-id="8cde9-103">Controlando controles de comportamento se Entity Framework Core manterá informações sobre uma instância de entidade em seu rastreador de alterações.</span><span class="sxs-lookup"><span data-stu-id="8cde9-103">Tracking behavior controls if Entity Framework Core will keep information about an entity instance in its change tracker.</span></span> <span data-ttu-id="8cde9-104">Se uma entidade é acompanhada, qualquer alteração detectada na entidade será mantida no banco de dados durante a `SaveChanges()`.</span><span class="sxs-lookup"><span data-stu-id="8cde9-104">If an entity is tracked, any changes detected in the entity will be persisted to the database during `SaveChanges()`.</span></span> <span data-ttu-id="8cde9-105">EF Core também corrigirá as propriedades de navegação entre as entidades em um resultado de consulta de rastreamento e as entidades que estão no controlador de alterações.</span><span class="sxs-lookup"><span data-stu-id="8cde9-105">EF Core will also fix up navigation properties between the entities in a tracking query result and the entities that are in the change tracker.</span></span>

> [!NOTE]
> <span data-ttu-id="8cde9-106">Os [tipos de entidade de subunidade](xref:core/modeling/keyless-entity-types) nunca são rastreados.</span><span class="sxs-lookup"><span data-stu-id="8cde9-106">[Keyless entity types](xref:core/modeling/keyless-entity-types) are never tracked.</span></span> <span data-ttu-id="8cde9-107">Sempre que este artigo menciona tipos de entidade, ele se refere a tipos de entidade que têm uma chave definida.</span><span class="sxs-lookup"><span data-stu-id="8cde9-107">Wherever this article mentions entity types, it refers to entity types which have a key defined.</span></span>

> [!TIP]  
> <span data-ttu-id="8cde9-108">Veja o [exemplo](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Querying) deste artigo no GitHub.</span><span class="sxs-lookup"><span data-stu-id="8cde9-108">You can view this article's [sample](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Querying) on GitHub.</span></span>

## <a name="tracking-queries"></a><span data-ttu-id="8cde9-109">Consultas com acompanhamento</span><span class="sxs-lookup"><span data-stu-id="8cde9-109">Tracking queries</span></span>

<span data-ttu-id="8cde9-110">Por padrão, as consultas que retornam tipos de entidade são de acompanhamento.</span><span class="sxs-lookup"><span data-stu-id="8cde9-110">By default, queries that return entity types are tracking.</span></span> <span data-ttu-id="8cde9-111">Isso significa que você pode fazer alterações nessas instâncias de entidade e fazer com que essas alterações persistiram por `SaveChanges()`.</span><span class="sxs-lookup"><span data-stu-id="8cde9-111">Which means you can make changes to those entity instances and have those changes persisted by `SaveChanges()`.</span></span> <span data-ttu-id="8cde9-112">No exemplo a seguir, a alteração para a classificação de blogs será detectada e persistida no banco de dados durante a `SaveChanges()`.</span><span class="sxs-lookup"><span data-stu-id="8cde9-112">In the following example, the change to the blogs rating will be detected and persisted to the database during `SaveChanges()`.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#Tracking)]

## <a name="no-tracking-queries"></a><span data-ttu-id="8cde9-113">Consultas sem controle</span><span class="sxs-lookup"><span data-stu-id="8cde9-113">No-tracking queries</span></span>

<span data-ttu-id="8cde9-114">As consulta sem acompanhamento são úteis quando os resultados são usados em um cenário de somente leitura.</span><span class="sxs-lookup"><span data-stu-id="8cde9-114">No tracking queries are useful when the results are used in a read-only scenario.</span></span> <span data-ttu-id="8cde9-115">Eles são mais rápidos de executar porque não há necessidade de configurar as informações de controle de alterações.</span><span class="sxs-lookup"><span data-stu-id="8cde9-115">They're quicker to execute because there's no need to set up the change tracking information.</span></span> <span data-ttu-id="8cde9-116">Se você não precisar atualizar as entidades recuperadas do banco de dados, uma consulta sem rastreamento deverá ser usada.</span><span class="sxs-lookup"><span data-stu-id="8cde9-116">If you don't need to update the entities retrieved from the database, then a no-tracking query should be used.</span></span> <span data-ttu-id="8cde9-117">Você pode trocar uma consulta individual como sem rastreamento.</span><span class="sxs-lookup"><span data-stu-id="8cde9-117">You can swap an individual query to be no-tracking.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#NoTracking)]

<span data-ttu-id="8cde9-118">Você também pode alterar o comportamento de acompanhamento padrão no nível de instância do contexto:</span><span class="sxs-lookup"><span data-stu-id="8cde9-118">You can also change the default tracking behavior at the context instance level:</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#ContextDefaultTrackingBehavior)]

## <a name="identity-resolution"></a><span data-ttu-id="8cde9-119">Resolução de identidade</span><span class="sxs-lookup"><span data-stu-id="8cde9-119">Identity resolution</span></span>

<span data-ttu-id="8cde9-120">Como uma consulta de rastreamento usa o rastreador de alterações, EF Core fará a resolução de identidade em uma consulta de rastreamento.</span><span class="sxs-lookup"><span data-stu-id="8cde9-120">Since a tracking query uses the change tracker, EF Core will do identity resolution in a tracking query.</span></span> <span data-ttu-id="8cde9-121">Ao materializar uma entidade, EF Core retornará a mesma instância de entidade do controlador de alteração se ela já estiver sendo acompanhada.</span><span class="sxs-lookup"><span data-stu-id="8cde9-121">When materializing an entity, EF Core will return the same entity instance from the change tracker if it's already being tracked.</span></span> <span data-ttu-id="8cde9-122">Se o resultado contiver a mesma entidade várias vezes, você obterá a mesma instância para cada ocorrência.</span><span class="sxs-lookup"><span data-stu-id="8cde9-122">If the result contains same entity multiple times, you get back same instance for each occurrence.</span></span> <span data-ttu-id="8cde9-123">As consultas sem controle não usam o controlador de alterações e não fazem a resolução de identidade.</span><span class="sxs-lookup"><span data-stu-id="8cde9-123">No-tracking queries don't use the change tracker and don't do identity resolution.</span></span> <span data-ttu-id="8cde9-124">Assim, você obtém uma nova instância da entidade, mesmo quando a mesma entidade está contida no resultado várias vezes.</span><span class="sxs-lookup"><span data-stu-id="8cde9-124">So you get back new instance of entity even when the same entity is contained in the result multiple times.</span></span> <span data-ttu-id="8cde9-125">Esse comportamento era diferente nas versões anteriores ao EF Core 3,0, consulte [versões antigas](#previous-versions).</span><span class="sxs-lookup"><span data-stu-id="8cde9-125">This behavior was different in versions before EF Core 3.0, see [previous versions](#previous-versions).</span></span>

## <a name="tracking-and-custom-projections"></a><span data-ttu-id="8cde9-126">Acompanhamento e projeções personalizadas</span><span class="sxs-lookup"><span data-stu-id="8cde9-126">Tracking and custom projections</span></span>

<span data-ttu-id="8cde9-127">Mesmo que o tipo de resultado da consulta não seja um tipo de entidade, EF Core ainda acompanhará os tipos de entidade contidos no resultado por padrão.</span><span class="sxs-lookup"><span data-stu-id="8cde9-127">Even if the result type of the query isn't an entity type, EF Core will still track entity types contained in the result by default.</span></span> <span data-ttu-id="8cde9-128">Na consulta a seguir, que retorna um tipo anônimo, as instâncias do `Blog` no conjunto de resultados será rastreado.</span><span class="sxs-lookup"><span data-stu-id="8cde9-128">In the following query, which returns an anonymous type, the instances of `Blog` in the result set will be tracked.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#CustomProjection1)]

<span data-ttu-id="8cde9-129">Se o conjunto de resultados contiver tipos de entidade provenientes da composição do LINQ, EF Core os controlará.</span><span class="sxs-lookup"><span data-stu-id="8cde9-129">If the result set contains entity types coming out from LINQ composition, EF Core will track them.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#CustomProjection2)]

<span data-ttu-id="8cde9-130">Se o conjunto de resultados não contiver nenhum tipo de entidade, nenhum controle será feito.</span><span class="sxs-lookup"><span data-stu-id="8cde9-130">If the result set doesn't contain any entity types, then no tracking is done.</span></span> <span data-ttu-id="8cde9-131">Na consulta a seguir, retornamos um tipo anônimo com alguns dos valores da entidade (mas nenhuma instância do tipo de entidade real).</span><span class="sxs-lookup"><span data-stu-id="8cde9-131">In the following query, we return an anonymous type with some of the values from the entity (but no instances of the actual entity type).</span></span> <span data-ttu-id="8cde9-132">Não há nenhuma entidade rastreada saindo da consulta.</span><span class="sxs-lookup"><span data-stu-id="8cde9-132">There are no tracked entities coming out of the query.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#CustomProjection3)]

 <span data-ttu-id="8cde9-133">O EF Core dá suporte à avaliação do cliente na projeção de nível superior.</span><span class="sxs-lookup"><span data-stu-id="8cde9-133">EF Core supports doing client evaluation in the top-level projection.</span></span> <span data-ttu-id="8cde9-134">Se EF Core materializar uma instância de entidade para avaliação do cliente, ela será controlada.</span><span class="sxs-lookup"><span data-stu-id="8cde9-134">If EF Core materializes an entity instance for client evaluation, it will be tracked.</span></span> <span data-ttu-id="8cde9-135">Aqui, como estamos passando `blog` entidades para o método de cliente `StandardizeURL`, EF Core também acompanhará as instâncias de blog.</span><span class="sxs-lookup"><span data-stu-id="8cde9-135">Here, since we're passing `blog` entities to the client method `StandardizeURL`, EF Core will track the blog instances too.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#ClientProjection)]

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#ClientMethod)]

<span data-ttu-id="8cde9-136">O EF Core não rastreia as instâncias de entidade sem o subconjunto contido no resultado.</span><span class="sxs-lookup"><span data-stu-id="8cde9-136">EF Core doesn't track the keyless entity instances contained in the result.</span></span> <span data-ttu-id="8cde9-137">Mas EF Core rastreia todas as outras instâncias de tipos de entidade com chave de acordo com as regras acima.</span><span class="sxs-lookup"><span data-stu-id="8cde9-137">But EF Core tracks all the other instances of entity types with key according to rules above.</span></span>

<span data-ttu-id="8cde9-138">Algumas das regras acima funcionaram de maneira diferente antes de EF Core 3,0.</span><span class="sxs-lookup"><span data-stu-id="8cde9-138">Some of the above rules worked differently before EF Core 3.0.</span></span> <span data-ttu-id="8cde9-139">Para obter mais informações, consulte [versões anteriores](#previous-versions).</span><span class="sxs-lookup"><span data-stu-id="8cde9-139">For more information, see [previous versions](#previous-versions).</span></span>

## <a name="previous-versions"></a><span data-ttu-id="8cde9-140">Versões anteriores</span><span class="sxs-lookup"><span data-stu-id="8cde9-140">Previous versions</span></span>

<span data-ttu-id="8cde9-141">Antes da versão 3,0, EF Core tinha algumas diferenças em como o controle foi feito.</span><span class="sxs-lookup"><span data-stu-id="8cde9-141">Before version 3.0, EF Core had some differences in how tracking was done.</span></span> <span data-ttu-id="8cde9-142">As diferenças notáveis são as seguintes:</span><span class="sxs-lookup"><span data-stu-id="8cde9-142">Notable differences are as follows:</span></span>

- <span data-ttu-id="8cde9-143">Conforme explicado na página [avaliação do cliente vs Server](xref:core/querying/client-eval) , EF Core avaliação de cliente com suporte em qualquer parte da consulta antes da versão 3,0.</span><span class="sxs-lookup"><span data-stu-id="8cde9-143">As explained in [Client vs Server Evaluation](xref:core/querying/client-eval) page, EF Core supported client evaluation in any part of the query before version 3.0.</span></span> <span data-ttu-id="8cde9-144">A avaliação do cliente causou a materialização das entidades, que não faziam parte do resultado.</span><span class="sxs-lookup"><span data-stu-id="8cde9-144">Client evaluation caused materialization of entities, which weren't part of the result.</span></span> <span data-ttu-id="8cde9-145">Portanto EF Core analisado o resultado para detectar o que rastrear. Esse design tinha determinadas diferenças, da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="8cde9-145">So EF Core analyzed the result to detect what to track. This design had certain differences as follows:</span></span>
  - <span data-ttu-id="8cde9-146">Avaliação do cliente na projeção, que causou a materialização, mas não retornou que a instância de entidade materializada não foi rastreada.</span><span class="sxs-lookup"><span data-stu-id="8cde9-146">Client evaluation in the projection, which caused materialization but didn't return the materialized entity instance wasn't tracked.</span></span> <span data-ttu-id="8cde9-147">O exemplo a seguir não acompanha `blog` entidades.</span><span class="sxs-lookup"><span data-stu-id="8cde9-147">The following example didn't track `blog` entities.</span></span>
    [!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#ClientProjection)]

  - <span data-ttu-id="8cde9-148">EF Core não rastreie os objetos provenientes da composição do LINQ em determinados casos.</span><span class="sxs-lookup"><span data-stu-id="8cde9-148">EF Core didn't track the objects coming out of LINQ composition in certain cases.</span></span> <span data-ttu-id="8cde9-149">O exemplo a seguir não acompanha `Post`.</span><span class="sxs-lookup"><span data-stu-id="8cde9-149">The following example didn't track `Post`.</span></span>
    [!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#CustomProjection2)]

- <span data-ttu-id="8cde9-150">Sempre que os resultados da consulta contiverem tipos de entidade sem nenhum tipo, a consulta inteira foi feita sem rastreamento.</span><span class="sxs-lookup"><span data-stu-id="8cde9-150">Whenever query results contained keyless entity types, the whole query was made non-tracking.</span></span> <span data-ttu-id="8cde9-151">Isso significa que os tipos de entidade com chaves, que, no resultado, não estavam sendo acompanhados.</span><span class="sxs-lookup"><span data-stu-id="8cde9-151">That means that entity types with keys, which are in result weren't being tracked either.</span></span>
- <span data-ttu-id="8cde9-152">EF Core a resolução de identidade na consulta sem rastreamento.</span><span class="sxs-lookup"><span data-stu-id="8cde9-152">EF Core did identity resolution in no-tracking query.</span></span> <span data-ttu-id="8cde9-153">Ele usou referências fracas para manter o controle das entidades que já foram retornadas.</span><span class="sxs-lookup"><span data-stu-id="8cde9-153">It used weak references to keep track of entities that had already been returned.</span></span> <span data-ttu-id="8cde9-154">Portanto, se um conjunto de resultados contiver a mesma entidade várias vezes, você obterá a mesma instância para cada ocorrência.</span><span class="sxs-lookup"><span data-stu-id="8cde9-154">So if a result set contained the same entity multiples times, you would get the same instance for each occurrence.</span></span> <span data-ttu-id="8cde9-155">No entanto, se um resultado anterior com a mesma identidade saiu do escopo e obtiver o lixo coletado, EF Core retornou uma nova instância.</span><span class="sxs-lookup"><span data-stu-id="8cde9-155">Though if a previous result with the same identity went out of scope and got garbage collected, EF Core returned a new instance.</span></span>
